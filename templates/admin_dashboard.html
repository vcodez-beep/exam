<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Exam Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container" style="max-width: 1200px;">
        <h1>üéØ Admin Dashboard</h1>
        <p style="text-align: center; margin-bottom: 20px;">
            <a href="{{ url_for('logout') }}"><button class="btn btn-danger" style="width: auto; padding: 10px 30px;">Logout</button></a>
        </p>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
            <div class="admin-section" style="margin-bottom: 0;">
                <h2>üîí Block Password Settings</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    {% if block_password %}
                    Password is currently set.
                    {% else %}
                    Default: 'exam2024'
                    {% endif %}
                </p>
                <form method="POST" action="{{ url_for('set_block_password') }}" autocomplete="off">
                    <div class="form-group">
                        <label for="block_password">New Block Password:</label>
                        <input type="password" id="block_password" name="block_password" placeholder="Enter new password" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn btn-success">Update Password</button>
                </form>
            </div>
            
            <div class="admin-section" style="margin-bottom: 0;">
                <h2>‚è±Ô∏è Exam Duration Settings</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    Current duration: <strong>{{ exam_duration }} minutes</strong>
                </p>
                <form method="POST" action="{{ url_for('set_exam_duration') }}">
                    <div class="form-group">
                        <label for="exam_duration">Exam Duration (minutes):</label>
                        <input type="number" id="exam_duration" name="exam_duration" value="{{ exam_duration }}" min="1" max="300" placeholder="Enter duration in minutes" required>
                    </div>
                    <button type="submit" class="btn btn-success">Update Duration</button>
                </form>
            </div>
        </div>
        
        <div class="admin-section">
            <h2>üìä Student Results ({{ user_data|length }} Students)</h2>
            
            {% if user_data %}
                <div id="user-list">
                    {% for data in user_data %}
                    <div class="user-list-item" onclick="toggleUserDetails('user-{{ loop.index }}')">
                        <div class="user-name">
                            {{ data.user.username }}
                        </div>
                        <div class="score-badge">
                            {% if data.total_questions > 0 %}
                                {{ "%.1f"|format(data.score) }}% ({{ data.correct_answers }}/{{ data.total_questions }})
                            {% else %}
                                No Attempt
                            {% endif %}
                        </div>
                    </div>
                    
                    <div id="user-{{ loop.index }}" class="user-details">
                        <div class="user-card expanded">
                            <div style="margin-bottom: 20px;">
                                <h3 style="color: #667eea; margin-bottom: 10px;">üìù Exam Details for {{ data.user.username }}</h3>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px;">
                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 28px; font-weight: 700;">{{ "%.1f"|format(data.score) }}%</div>
                                        <div style="font-size: 14px; opacity: 0.9;">Overall Score</div>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 28px; font-weight: 700;">{{ data.correct_answers }}</div>
                                        <div style="font-size: 14px; opacity: 0.9;">Correct Answers</div>
                                    </div>
                                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 28px; font-weight: 700;">{{ data.total_questions - data.correct_answers }}</div>
                                        <div style="font-size: 14px; opacity: 0.9;">Wrong Answers</div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if data.responses %}
                            <table class="response-table">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 35%;">Question</th>
                                        <th style="width: 20%;">Student Answer</th>
                                        <th style="width: 20%;">Correct Answer</th>
                                        <th style="width: 20%;">Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for response in data.responses %}
                                    <tr>
                                        <td style="font-weight: 700; color: #667eea;">{{ loop.index }}</td>
                                        <td>{{ response.question.question_text[:80] }}{% if response.question.question_text|length > 80 %}...{% endif %}</td>
                                        <td>
                                            {% if response.question.question_type == 'MCQ' %}
                                                <strong>{{ response.user_answer or 'Not Answered' }}</strong>
                                            {% else %}
                                                {{ (response.user_answer_text[:30] + '...') if response.user_answer_text and response.user_answer_text|length > 30 else (response.user_answer_text or 'Not Answered') }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if response.question.question_type == 'MCQ' %}
                                                <strong>{{ response.question.correct_answer }}</strong>
                                            {% else %}
                                                <em style="color: #999;">Needs grading</em>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if response.question.question_type == 'MCQ' %}
                                                {% if response.is_correct %}
                                                    <span class="correct">‚úì Correct</span>
                                                    <div style="font-size: 12px; color: #666;">+{{ response.points_earned }} pts</div>
                                                {% else %}
                                                    <span class="incorrect">‚úó Wrong</span>
                                                    <div style="font-size: 12px; color: #666;">0 pts</div>
                                                {% endif %}
                                            {% else %}
                                                <span style="color: #666;">Manual grading</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p style="color: #999; font-style: italic; text-align: center; padding: 20px;">No exam responses yet</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                    <p style="font-size: 18px;">No students have registered yet.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="admin-section">
            <h2>‚ûï Create New Question</h2>
            <form method="POST" action="{{ url_for('create_question') }}" id="question-form">
                <div class="form-group">
                    <label for="question_type">Question Type:</label>
                    <select id="question_type" name="question_type" class="form-select" onchange="toggleQuestionFields()" required>
                        <option value="MCQ">Multiple Choice (MCQ)</option>
                        <option value="SHORT_ANSWER">Short Answer</option>
                        <option value="PARAGRAPH">Paragraph</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="question_text">Question:</label>
                    <textarea id="question_text" name="question_text" rows="3" required></textarea>
                </div>
                
                <div id="mcq-options">
                    <div class="form-group">
                        <label for="option_a">Option A:</label>
                        <input type="text" id="option_a" name="option_a">
                    </div>
                    <div class="form-group">
                        <label for="option_b">Option B:</label>
                        <input type="text" id="option_b" name="option_b">
                    </div>
                    <div class="form-group">
                        <label for="option_c">Option C:</label>
                        <input type="text" id="option_c" name="option_c">
                    </div>
                    <div class="form-group">
                        <label for="option_d">Option D:</label>
                        <input type="text" id="option_d" name="option_d">
                    </div>
                    <div class="form-group">
                        <label for="correct_answer">Correct Answer:</label>
                        <select id="correct_answer" name="correct_answer" class="form-select">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                </div>
                
                <div id="text-answer" style="display: none;">
                    <div class="form-group">
                        <label for="correct_answer_text">Expected Answer (optional for grading reference):</label>
                        <textarea id="correct_answer_text" name="correct_answer_text" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="points">Points:</label>
                    <input type="number" id="points" name="points" value="1" min="1" required>
                </div>
                
                <button type="submit" class="btn btn-success">Create Question</button>
            </form>
        </div>
        
        <div class="admin-section">
            <h2>üìö All Questions ({{ questions|length }})</h2>
            {% if questions %}
                {% for question in questions %}
                <div class="question-card" style="position: relative;">
                    <div class="question-text">
                        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 6px; margin-right: 10px; font-size: 14px;">{{ loop.index }}</span>
                        [{{ question.question_type }}] {{ question.question_text }}
                        <span style="float: right; font-size: 14px; color: #667eea; font-weight: 700;">{{ question.points }} pts</span>
                    </div>
                    <div style="margin-left: 20px; margin-top: 15px;">
                        {% if question.question_type == 'MCQ' %}
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <p style="padding: 8px; background: #f7fafc; border-radius: 6px;"><strong>A)</strong> {{ question.option_a }}</p>
                                <p style="padding: 8px; background: #f7fafc; border-radius: 6px;"><strong>B)</strong> {{ question.option_b }}</p>
                                <p style="padding: 8px; background: #f7fafc; border-radius: 6px;"><strong>C)</strong> {{ question.option_c }}</p>
                                <p style="padding: 8px; background: #f7fafc; border-radius: 6px;"><strong>D)</strong> {{ question.option_d }}</p>
                            </div>
                            <p style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%); border-radius: 6px; border-left: 4px solid #28a745;">
                                <strong class="correct">‚úì Correct Answer: {{ question.correct_answer }}</strong>
                            </p>
                        {% else %}
                            <p style="color: #666; font-style: italic; padding: 12px; background: #f7fafc; border-radius: 6px;">
                                {% if question.question_type == 'SHORT_ANSWER' %}
                                    üìù Short answer question (requires manual grading)
                                {% else %}
                                    üìÑ Paragraph question (requires manual grading)
                                {% endif %}
                            </p>
                            {% if question.correct_answer_text %}
                                <p style="margin-top: 10px; padding: 12px; background: #f7fafc; border-radius: 6px;"><strong>Expected Answer:</strong> {{ question.correct_answer_text }}</p>
                            {% endif %}
                        {% endif %}
                    </div>
                    <form method="POST" action="{{ url_for('delete_question', question_id=question.id) }}" style="margin-top: 15px;">
                        <button type="submit" class="btn btn-danger" style="width: auto; padding: 8px 24px; font-size: 14px;" onclick="return confirm('Are you sure you want to delete this question? This action cannot be undone.')">üóëÔ∏è Delete Question</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                    <p style="font-size: 18px;">No questions created yet. Create your first question above!</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        function toggleQuestionFields() {
            const questionType = document.getElementById('question_type').value;
            const mcqOptions = document.getElementById('mcq-options');
            const textAnswer = document.getElementById('text-answer');
            
            if (questionType === 'MCQ') {
                mcqOptions.style.display = 'block';
                textAnswer.style.display = 'none';
                document.getElementById('option_a').required = true;
                document.getElementById('option_b').required = true;
                document.getElementById('option_c').required = true;
                document.getElementById('option_d').required = true;
            } else {
                mcqOptions.style.display = 'none';
                textAnswer.style.display = 'block';
                document.getElementById('option_a').required = false;
                document.getElementById('option_b').required = false;
                document.getElementById('option_c').required = false;
                document.getElementById('option_d').required = false;
            }
        }
        
        function toggleUserDetails(userId) {
            const userDetails = document.getElementById(userId);
            const isActive = userDetails.classList.contains('active');
            
            // Close all other user details
            const allDetails = document.querySelectorAll('.user-details');
            allDetails.forEach(detail => {
                detail.classList.remove('active');
            });
            
            // Toggle current user details
            if (!isActive) {
                userDetails.classList.add('active');
            }
        }
    </script>
</body>
</html>
